name: Deploy Unified Documentation to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'krrood/doc/**'
      - 'pycram/doc/**'
      - 'semantic_digital_twin/doc/**'
      - '.github/workflows/deploy-unified-docs.yml'

# This workflow builds all documentation and deploys to GitHub Pages
jobs:
  # ============================================================================
  # Build krrood documentation
  # ============================================================================
  build-krrood-docs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip

    - name: Install krrood dependencies
      working-directory: ./krrood
      run: |
        pip install -U pip setuptools
        pip install -r requirements-dev.txt
        pip install .
        pip install -r doc/requirements.txt

    - name: Build krrood documentation
      working-directory: ./krrood
      run: |
        jupyter-book build doc

    - name: Upload krrood docs
      uses: actions/upload-artifact@v4
      with:
        name: krrood-docs
        path: krrood/doc/_build/html

  # ============================================================================
  # Build pycram documentation
  # ============================================================================
  build-pycram-docs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz graphviz-dev

    - name: Install pycram dependencies
      working-directory: ./pycram
      run: |
        pip install -U pip setuptools
        pip install -r requirements.txt
        pip install -r doc/requirements.txt

    - name: Build pycram documentation
      working-directory: ./pycram/doc/source
      run: |
        jupyter-book build .

    - name: Upload pycram docs
      uses: actions/upload-artifact@v4
      with:
        name: pycram-docs
        path: pycram/doc/source/_build/html

  # ============================================================================
  # Build semantic_digital_twin documentation
  # ============================================================================
  build-semantic-docs:
    runs-on: ubuntu-latest
    container:
      image: "pycram/semantic_world:jazzy"
    defaults:
      run:
        shell: bash -ieo pipefail {0}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: "ros/src/semantic_digital_twin"
        repository: ${{ github.repository }}
        ref: ${{ github.ref }}
        submodules: 'false'

    - name: Update semantic_digital_twin source files
      run: |
        rm -rf /opt/ros/semantic_digital_twin/* 
        cd /opt/ros/semantic_digital_twin
        rm -rf .git .github .gitignore .gitmodules .readthedocs.yaml
        cp -r /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}/ros/src/semantic_digital_twin /opt/ros

    - name: Install dependencies
      run: |
        sudo apt-get update
        cd /opt/ros/semantic_digital_twin
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        pip install -U pip && pip install -r requirements.txt && pip install . && pip install -r doc/requirements.txt

    - name: Strip exercise-tagged cells in self_assessment/exercises/
      run: |
        cd /opt/ros/semantic_digital_twin/doc/self_assessment/exercises
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        find . -type f -name '*.md' -print0 | while IFS= read -r -d '' f; do
          ipynb="${f%.md}.ipynb"
          # md:myst -> ipynb
          jupytext --from md:myst --to ipynb "$f" -o "$ipynb"
          # drop cells tagged "exercise"
          jupyter nbconvert --config /opt/ros/semantic_digital_twin/scripts/configs/nb_remove_exercises.json \
            --to notebook --inplace \
            "$ipynb"
          # ipynb -> md:myst (overwrite original .md)
          jupytext --to md:myst "$ipynb" -o "$f"
          rm -f "$ipynb"
        done

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build semantic_digital_twin documentation
      run: |
        cd /opt/ros/semantic_digital_twin
        source /opt/ros/overlay_ws/install/setup.bash
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        jupyter-book build doc

    - name: Upload semantic_digital_twin docs
      uses: actions/upload-artifact@v4
      with:
        name: semantic-docs
        path: /opt/ros/semantic_digital_twin/doc/_build/html

  # ============================================================================
  # Combine and deploy all documentation
  # ============================================================================
  deploy-combined-docs:
    needs: [build-krrood-docs, build-pycram-docs, build-semantic-docs]
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download krrood docs
      uses: actions/download-artifact@v4
      with:
        name: krrood-docs
        path: _combined_docs/krrood

    - name: Download pycram docs
      uses: actions/download-artifact@v4
      with:
        name: pycram-docs
        path: _combined_docs/pycram

    - name: Download semantic_digital_twin docs
      uses: actions/download-artifact@v4
      with:
        name: semantic-docs
        path: _combined_docs/semantic_digital_twin

    - name: Create index page
      run: |
        # Create .nojekyll to disable Jekyll processing
        touch _combined_docs/.nojekyll
        
        cat > _combined_docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>CRAM Documentation</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 40px 20px;
                    background-color: #f5f5f5;
                }
                h1 {
                    color: #333;
                    text-align: center;
                }
                .docs-list {
                    list-style: none;
                    padding: 0;
                }
                .docs-list li {
                    margin: 20px 0;
                }
                .docs-list a {
                    display: block;
                    padding: 20px;
                    background-color: white;
                    color: #0366d6;
                    text-decoration: none;
                    border-radius: 6px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
                    transition: box-shadow 0.2s;
                }
                .docs-list a:hover {
                    box-shadow: 0 4px 6px rgba(0,0,0,0.16);
                }
                .docs-title {
                    font-size: 1.5em;
                    font-weight: bold;
                    margin-bottom: 8px;
                }
                .docs-desc {
                    color: #586069;
                    font-size: 0.9em;
                }
            </style>
        </head>
        <body>
            <h1>CRAM Documentation</h1>
            <ul class="docs-list">
                <li>
                    <a href="./krrood/">
                        <div class="docs-title">krrood</div>
                        <div class="docs-desc">Knowledge Representation and Reasoning for Object-Oriented Domains</div>
                    </a>
                </li>
                <li>
                    <a href="./pycram/">
                        <div class="docs-title">pycram</div>
                        <div class="docs-desc">Python Cognitive Robot Abstract Machine</div>
                    </a>
                </li>
                <li>
                    <a href="./semantic_digital_twin/">
                        <div class="docs-title">semantic_digital_twin</div>
                        <div class="docs-desc">Semantic Digital Twin Documentation</div>
                    </a>
                </li>
            </ul>
        </body>
        </html>
        EOF

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _combined_docs

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

